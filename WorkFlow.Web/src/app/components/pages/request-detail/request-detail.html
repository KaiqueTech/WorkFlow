<div *ngIf="request; else loadingState" class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6 bg-black min-h-screen">
  
  <div class="lg:col-span-2 space-y-6">
    <div class="bg-zinc-900 p-8 rounded-2xl border border-zinc-800 shadow-xl">
      
      <div class="flex justify-between items-start mb-6">
        <div>
          <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-zinc-800 text-purple-400 border border-purple-500/30">
            {{ categoryMap[request.category] || 'Categoria' }} 
          </span>
          <h1 class="text-3xl font-bold text-white mt-4">{{ request.title }}</h1>
        </div>

        <div *ngIf="statusConfig[request.status]" 
             [class]="'px-4 py-2 rounded-lg border font-bold text-sm uppercase flex items-center gap-2 ' + statusConfig[request.status].bg + ' ' + statusConfig[request.status].color">
          <mat-icon class="!text-[18px] w-[18px] h-[18px]">{{ statusConfig[request.status].icon }}</mat-icon>
          {{ statusConfig[request.status].label }}
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-8 text-sm">
        <div class="text-gray-400 flex items-center gap-2">
          Prioridade: 
          <span [class]="'font-semibold ' + (priorityConfig[request.priority]?.color || 'text-white')">
             {{ priorityConfig[request.priority]?.label || 'Normal' }}
          </span>
        </div>
        <div class="text-gray-400">Criado em: <span class="text-white font-semibold">{{ request.createdAt | date:'dd/MM/yyyy HH:mm' }}</span></div>
      </div>

      <div class="space-y-2">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</label>
        <p class="text-gray-300 leading-relaxed bg-black/30 p-4 rounded-lg border border-zinc-800">
          {{ request.description || 'Nenhuma descrição fornecida.' }}
        </p>
      </div>

      <div *ngIf="request.status === 0" class="mt-10 pt-8 border-t border-zinc-800 flex gap-4">
    
      <ng-container *ngIf="isManager">
        <button (click)="abrirModalDecisao(true)" class="bg-indigo-600 p-3 rounded-xl flex-1 text-white font-bold">
          Aprovar (Como Gestor)
        </button>
        <button (click)="abrirModalDecisao(false)" class="bg-red-600 p-3 rounded-xl flex-1 text-white font-bold">
          Rejeitar
        </button>
      </ng-container>

        <div *ngIf="!isManager" class="text-zinc-500 italic text-center w-full">
          Aguardando aprovação (Sua role atual não permite editar)
        </div>
      </div>
    </div>
  </div>

  <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 shadow-xl overflow-hidden">
    <h3 class="text-lg font-bold text-white mb-8 flex items-center gap-2">
      <span class="w-2 h-6 bg-purple-500 rounded-full"></span>
      Histórico de Alterações 
    </h3>

    <div *ngIf="history.length === 0" class="text-center py-10">
       <mat-icon class="text-zinc-700 !text-5xl w-12 h-12 mb-2">history</mat-icon>
       <p class="text-zinc-500 text-xs">Nenhuma alteração registrada.</p>
    </div>

    <div class="relative border-l-2 border-zinc-800 ml-4 space-y-8 pb-4">
      <div *ngFor="let step of history" class="relative pl-8">
        <div [class]="'absolute -left-[9px] top-1 w-4 h-4 rounded-full border-4 border-zinc-900 ' + (statusConfig[step.toStatus]?.color || 'bg-zinc-500').replace('text', 'bg')"></div>
        
        <div class="flex flex-col">
          <span [class]="'font-bold text-sm uppercase tracking-tight ' + (statusConfig[step.toStatus]?.color || 'text-white')">
            {{ statusConfig[step.toStatus]?.label || 'Alterado' }}
          </span>
          <span class="text-gray-500 text-[10px] mb-2">{{ step.changedAt | date:'dd/MM/yyyy HH:mm' }}</span>
          
          <div class="bg-black/50 p-3 rounded-lg border border-zinc-800/50">
            <p class="text-gray-400 text-xs italic">"{{ step.comment || 'Sem observações.' }}"</p>
            <p class="text-purple-400 text-[10px] mt-2 font-semibold flex items-center gap-1">
              <mat-icon class="!text-[12px] w-3 h-3">person</mat-icon>
              {{ step.changedBy }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingState>
  <div class="flex flex-col items-center justify-center min-h-screen bg-black gap-4">
    <div class="w-12 h-12 border-4 border-purple-500/20 border-t-purple-500 rounded-full animate-spin"></div>
    <p class="text-zinc-500 font-medium animate-pulse">Sincronizando dados...</p>
  </div>
</ng-template>